<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Paper Format for 80mm Thermal Printer -->
        <record id="paperformat_thermal_80mm" model="report.paperformat">
            <field name="name">Thermal 80mm</field>
            <field name="default" eval="False"/>
            <field name="format">custom</field>
            <field name="page_height">0</field>
            <field name="page_width">80</field>
            <field name="orientation">Portrait</field>
            <field name="margin_top">0</field>
            <field name="margin_bottom">0</field>
            <field name="margin_left">0</field>
            <field name="margin_right">0</field>
            <field name="header_line" eval="False"/>
            <field name="header_spacing">0</field>
            <field name="dpi">90</field>
            <field name="disable_shrinking" eval="True"/>
        </record>

        <!-- Report Action -->
        <record id="action_report_pos_invoice_thermal" model="ir.actions.report">
            <field name="name">Thermal Invoice</field>
            <field name="model">account.move</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">pos_payment_oma.report_invoice_thermal</field>
            <field name="report_file">pos_payment_oma.report_invoice_thermal</field>
            <field name="print_report_name">'Invoice - %s' % (object.name)</field>
            <field name="paperformat_id" ref="pos_payment_oma.paperformat_thermal_80mm"/>
            <field name="binding_model_id" ref="account.model_account_move"/>
            <field name="binding_type">report</field>
        </record>

        <!-- Thermal Template matching Standard POS Receipt -->
        <template id="report_invoice_thermal">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <div class="page" style="font-family: 'Arial', 'Helvetica', sans-serif; font-size: 14px; width: 100%;">
                        
                        <!-- POS Specific Logic -->
                        <t t-set="pos_order" t-value="o.pos_order_ids[0] if o.pos_order_ids else None"/>

                        <!-- Header -->
                        <div class="text-center mb-3">
                            <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)" style="max-height: 70px; max-width: 90%; margin-bottom: 5px;" alt="Logo"/>
                            <div class="fw-bold" style="font-size: 16px;" t-field="o.company_id.name"/>
                            <div t-if="o.company_id.phone" t-field="o.company_id.phone"/>
                            <div t-if="o.company_id.email" t-field="o.company_id.email"/>
                            <div t-if="o.company_id.website" t-field="o.company_id.website"/>
                            <br/>
                            <div t-if="o.user_id">Served by <span t-field="o.user_id.name"/></div>
                            <!-- Table Info -->
                            <div t-if="pos_order and pos_order.table_id">
                                <span t-field="pos_order.table_id.name"/>, Guests: <span t-field="pos_order.customer_count"/>
                            </div>
                        </div>

                        <!-- Order Ref (Big) -->
                        <div class="text-center mb-4">
                            <!-- Use POS Reference if available (e.g. 00061-001-0001) or Tracking Number (101) -->
                            <t t-if="pos_order">
                                <span style="font-size: 24px; font-weight: bold;" t-esc="pos_order.tracking_number or pos_order.pos_reference"/>
                            </t>
                            <t t-else="">
                                <span style="font-size: 20px; font-weight: bold;" t-field="o.name"/>
                            </t>
                            <br/>
                            <span class="text-muted" style="font-size: 12px;" t-field="o.invoice_date"/>
                        </div>

                        <!-- Lines (Standard POS Receipt Style) -->
                        <div class="mb-4">
                            <t t-foreach="o.invoice_line_ids" t-as="line">
                                <t t-if="line.display_type == 'product' or not line.display_type">
                                    <div class="mb-2 border-bottom pb-1 border-light">
                                        <!-- Row 1: Name and Total Price -->
                                        <div class="d-flex justify-content-between">
                                            <span class="fw-bold text-wrap" style="width: 70%;" t-esc="line.product_id.display_name or line.name"/>
                                            <span class="fw-bold text-nowrap" t-field="line.price_total"/>
                                        </div>
                                        <!-- Row 2: Qty x Unit Price -->
                                        <div class="text-muted" style="font-size: 12px;">
                                            <span t-field="line.quantity"/> x <span t-field="line.price_unit"/> / <span t-field="line.product_uom_id.name"/>
                                            <t t-if="line.discount &gt; 0">
                                                <br/>
                                                <span class="fst-italic">Disc: <span t-field="line.discount"/>%</span>
                                            </t>
                                        </div>
                                    </div>
                                </t>
                            </t>
                        </div>

                        <!-- Totals -->
                        <div class="mb-3">
                             <div class="d-flex justify-content-between">
                                <span>Subtotal</span>
                                <span t-field="o.amount_untaxed"/>
                            </div>
                             <div class="d-flex justify-content-between text-muted" t-if="o.amount_tax > 0">
                                <span>Tax</span>
                                <span t-field="o.amount_tax"/>
                            </div>
                             <div class="d-flex justify-content-between border-top border-dark mt-2 pt-2" style="font-size: 18px; font-weight: bold;">
                                <span>TOTAL</span>
                                <span t-field="o.amount_total"/>
                            </div>
                            
                            <!-- Payment Details (if POS Order linked) -->
                            <t t-if="pos_order">
                                <t t-foreach="pos_order.payment_ids" t-as="payment">
                                    <div class="d-flex justify-content-between text-muted mt-1" style="font-size: 12px;">
                                        <span t-field="payment.payment_method_id.name"/>
                                        <span t-field="payment.amount" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                    </div>
                                </t>
                                <div class="d-flex justify-content-between text-muted mt-1" style="font-size: 12px;" t-if="pos_order.amount_return > 0">
                                    <span>Change</span>
                                    <span t-field="pos_order.amount_return" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </div>
                            </t>
                        </div>
                        
                        <!-- Footer -->
                        <div class="text-center mt-4 text-muted" style="font-size: 11px;">
                            Powered by Odoo
                             <br/>
                            <t t-if="pos_order">
                                <span t-field="pos_order.pos_reference"/>
                            </t>
                            <t t-else="">
                                <span t-field="o.name"/>
                            </t>
                        </div>

                    </div>
                </t>
            </t>
        </template>
    </data>
</odoo>
